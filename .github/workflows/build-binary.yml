name: Build and Release Binary

on:
  push:
    branches: [ dev ]
    paths:
      - 'main.go'
      - 'go.mod'
      - 'go.sum'
      - 'Dockerfile'
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        ref: dev

    - name: Setup Go
      uses: actions/setup-go@v5
      with:
        go-version: '1.22'
        cache: true

    - name: Build binaries
      run: |
        mkdir -p dist
        
        echo "Building for Linux AMD64..."
        CGO_ENABLED=0 GOOS=linux GOARCH=amd64 go build -o dist/super-tunnel_linux_amd64 main.go
        
        echo "Building for Linux ARM64..."
        CGO_ENABLED=0 GOOS=linux GOARCH=arm64 go build -o dist/super-tunnel_linux_arm64 main.go
        
        echo "Building for Windows AMD64..."
        CGO_ENABLED=0 GOOS=windows GOARCH=amd64 go build -o dist/super-tunnel_windows_amd64.exe main.go
        
        echo "Building for macOS AMD64..."
        CGO_ENABLED=0 GOOS=darwin GOARCH=amd64 go build -o dist/super-tunnel_darwin_amd64 main.go

        echo "Building for macOS ARM64..."
        CGO_ENABLED=0 GOOS=darwin GOARCH=arm64 go build -o dist/super-tunnel_darwin_arm64 main.go

    - name: Make binaries executable (Linux/Mac)
      run: |
        chmod +x dist/super-tunnel_linux_*
        chmod +x dist/super-tunnel_darwin_*
        ls -lh dist/

    - name: Delete existing release
      uses: actions/github-script@v7
      continue-on-error: true
      with:
        script: |
          const releases = await github.rest.repos.listReleases({
            owner: context.repo.owner,
            repo: context.repo.repo,
          });
          
          const release = releases.data.find(r => r.tag_name === 'go-binary');
          if (release) {
            await github.rest.repos.deleteRelease({
              owner: context.repo.owner,
              repo: context.repo.repo,
              release_id: release.id,
            });
            console.log('Deleted existing release');
          }

    - name: Delete existing tag
      continue-on-error: true
      run: |
        git push --delete origin go-binary || true

    - name: Wait for deletion
      run: sleep 3

    - name: Create or Update Release
      uses: softprops/action-gh-release@v1
      with:
        tag_name: go-binary
        name: Super-Tunnel Go Binary
        draft: false
        prerelease: false
        files: |
          dist/*
        body: |
          ## Super-Tunnel Go Binary (Latest Dev Build)
          
          **‚ö†Ô∏è This release is automatically updated with each push to dev branch**
          
          ### üì¶ Binaries
          - `super-tunnel_linux_amd64` - Linux x64
          - `super-tunnel_linux_arm64` - Linux ARM64
          - `super-tunnel_windows_amd64.exe` - Windows x64
          - `super-tunnel_darwin_amd64` - macOS Intel
          - `super-tunnel_darwin_arm64` - macOS Apple Silicon
          
          ### üöÄ Quick Start
          ```bash
          # Linux/macOS
          chmod +x super-tunnel_linux_amd64
          ./super-tunnel_linux_amd64
          ```
          
          ### üìù Environment Variables
          - `UUID` - User UUID (VLESS/Trojan Password)
          - `PORT` - Server port (default: 3000)
          - `DOMAIN` - Domain name (for subscription links)
          - `PROXY_IP` - Preferred Cloudflare IP/Domain (default: cdns.doon.eu.org)
          - `WSPATH` - WebSocket path (auto-generated from UUID if empty)
          - `SUB_PATH` - Subscription path (default: sub)
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
